<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>batchtools • batchtools</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="batchtools">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">batchtools</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.9.17-9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fa-file-alt"></span> Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr3book.mlr-org.com"><span class="fa fa-link"></span> mlr3book</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlr-org/batchtools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/"><span class="fa fa-comments"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"><span class="fa fab fa-stack-overflow"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://mlr-org.com/"><span class="fa fa-rss"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>batchtools</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/batchtools/blob/main/vignettes/batchtools.Rmd" class="external-link"><code>vignettes/batchtools.Rmd</code></a></small>
      <div class="d-none name"><code>batchtools.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="section level3">
<h3 id="cluster-functions">Cluster Functions<a class="anchor" aria-label="anchor" href="#cluster-functions"></a>
</h3>
<p>The communication with the batch system is managed via so-called
cluster functions. They are created with the constructor <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctions" class="external-link">makeClusterFunctions</a>
which defines how jobs are submitted on your system. Furthermore, you
may provide functions to list queued/running jobs and to kill jobs.</p>
<p>Usually you do not have to start from scratch but can just use one of
the cluster functions which ship with the package:</p>
<ul>
<li>Interactive Cluster Functions (default): <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsInteractive" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsInteractive.R" class="external-link">implementation</a>
</li>
<li>Multicore Cluster Functions: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsMulticore" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsMulticore.R" class="external-link">implementation</a>
</li>
<li>Socket Cluster Functions: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsSocket" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsSocket.R" class="external-link">implementation</a>
</li>
<li>Makeshift SSH cluster: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsSSH" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsSSH.R" class="external-link">implementation</a>
</li>
<li>Docker Swarm: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsDocker" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsDocker.R" class="external-link">implementation</a>
</li>
<li>IBM Spectrum Load Sharing Facility (LSF): <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsLSF" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsLSF.R" class="external-link">implementation</a>
</li>
<li>OpenLava: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsOpenLava" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsOpenLava.R" class="external-link">implementation</a>
</li>
<li>Univa Grid Engine / Oracle Grid Engine (OGE) / Sun Grid Engine
(SGE): <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsSGE" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsSGE.R" class="external-link">implementation</a>
</li>
<li>Slurm: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsSlurm" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsSlurm.R" class="external-link">implementation</a>
</li>
<li>TORQUE/OpenPBS: <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsTORQUE" class="external-link">docs</a>,
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsTORQUE.R" class="external-link">implementation</a>
</li>
</ul>
<p>To use the package with the socket cluster functions, you would call
the respective constructor <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctionsSocket" class="external-link">makeClusterFunctionsSocket()</a>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeRegistry.html">makeRegistry</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span><span class="va">reg</span><span class="op">$</span><span class="va">cluster.functions</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeClusterFunctionsSocket.html">makeClusterFunctionsSocket</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>To make this selection permanent for this registry, save the Registry
with <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link">saveRegistry()</a>.
To make your cluster function selection permanent for a specific system
across R sessions for all new Registries, you can set up a configuration
file (see below).</p>
<p>If you have trouble debugging your cluster functions, you can enable
the debug mode for extra output. To do so, install the <a href="https://cran.r-project.org/package=debugme" class="external-link">debugme package</a>
and set the environment variable <code>DEBUGME</code> to
<code>batchtools</code> before you load the <code>batchtools</code>
package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>DEBUGME <span class="op">=</span> <span class="st">"batchtools"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/batchtools" class="external-link">batchtools</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="template-files">Template Files<a class="anchor" aria-label="anchor" href="#template-files"></a>
</h3>
<p>Many cluster functions require a template file as argument. These
templates are used to communicate with the scheduler and contain
placeholders to evaluate arbitrary R expressions. Internally, the <a href="https://cran.r-project.org/package=brew" class="external-link">brew package</a> is used
for this purpose. Some exemplary template files can be found <a href="https://github.com/mllg/batchtools/tree/master/inst/templates" class="external-link">here</a>.
It would be great if you would help expand this collection to cover more
exotic configurations. To do so, please send your template via <a href="mailto:michellang@gmail.com">mail</a> or open a new pull
request.</p>
<p>Note that all variables defined in a <a href="https://mllg.github.io/batchtools/reference/JobCollection" class="external-link">JobCollection</a>
can be used inside the template. If you need to pass extra variables,
you can set them via the argument <code>resources</code> of <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link"><code>submitJobs()</code></a>.</p>
<p>If the flexibility which comes with templating is not sufficient, you
can still construct a custom cluster function implementation yourself
using the provided <a href="https://mllg.github.io/batchtools/reference/makeClusterFunctions" class="external-link">constructor</a>.</p>
</div>
<div class="section level3">
<h3 id="configuration-file">Configuration File<a class="anchor" aria-label="anchor" href="#configuration-file"></a>
</h3>
<p>The configuration file can be used to set system specific options.
Its default location depends on the operating system (see <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link">Registry</a>),
but for the first time setup you can put one in the current working
directory (as reported by <code><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd()</a></code>). In order to set the
cluster function implementation, you would generate a file with the
following content:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster.functions</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeClusterFunctionsInteractive.html">makeClusterFunctionsInteractive</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The configuration file is parsed whenever you create or load a <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link">Registry</a>.
It is sourced inside of your registry which has the advantage that you
can (a) access all of the parameters which are passed to <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link">makeRegistry</a>
and (b) you can also directly change them. Lets say you always want your
working directory in your home directory and you always want to load the
<code>checkmate</code> package on the nodes, you can just append these
lines:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">work.dir</span> <span class="op">=</span> <span class="st">"~"</span></span>
<span><span class="va">packages</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">packages</span>, <span class="st">"checkmate"</span><span class="op">)</span></span></code></pre></div>
<p>See the documentation on <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link">Registry</a>
for a more complete list of supported configuration options.</p>
</div>
</div>
<div class="section level2">
<h2 id="migration-from-batchjobsbatchexperiments">Migration from
<code>BatchJobs</code>/<code>Batchexperiments</code><a class="anchor" aria-label="anchor" href="#migration-from-batchjobsbatchexperiments"></a>
</h2>
<p>The development of <a href="https://github.com/tudo-r/BatchJobs/" class="external-link">BatchJobs</a> and <a href="https://github.com/tudo-r/Batchexperiments" class="external-link">BatchExperiments</a>
is discontinued because of the following reasons:</p>
<ul>
<li>Maintainability: The packages <a href="https://github.com/tudo-r/BatchJobs/" class="external-link">BatchJobs</a> and <a href="https://github.com/tudo-r/Batchexperiments" class="external-link">BatchExperiments</a>
are tightly connected which makes maintaining difficult. Changes have to
be synchronized and tested against the current CRAN versions for
compatibility. Furthermore, BatchExperiments violates CRAN policies by
calling internal functions of BatchJobs.</li>
<li>Data base issues: Although we invested weeks to mitigate issues with
locks of the SQLite data base or file system (staged queries, file
system timeouts, …), BatchJobs kept working unreliable on some systems
with high latency or specific file systems. This made BatchJobs unusable
for many users.</li>
</ul>
<p><a href="https://github.com/tudo-r/BatchJobs/" class="external-link">BatchJobs</a> and <a href="https://github.com/tudo-r/Batchexperiments" class="external-link">BatchExperiments</a>
will remain on CRAN, but new features are unlikely to be ported
back.</p>
<div class="section level3">
<h3 id="internal-changes">Internal Changes<a class="anchor" aria-label="anchor" href="#internal-changes"></a>
</h3>
<ul>
<li>batchtools does not use SQLite anymore. Instead, all the information
is stored directly in the registry using <a href="https://cran.r-project.org/package=data.table" class="external-link">data.tables</a>
acting as an in-memory database. As a side effect, many operations are
much faster.</li>
<li>Nodes do not have to access the registry. <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link">submitJobs()</a>
stores a temporary object of type <a href="https://mllg.github.io/batchtools/reference/JobCollection" class="external-link">JobCollection</a>
on the file system which holds all the information necessary to execute
a chunk of jobs via <a href="https://mllg.github.io/batchtools/reference/doJobCollection" class="external-link">doJobCollection()</a>
on the node. This avoids file system locks because each job accesses
only one file exclusively.</li>
<li>
<code>ClusterFunctionsMulticore</code> now uses the parallel package
for multicore execution.</li>
<li>
<code>ClusterFunctionsSSH</code> can still be used to emulate a
scheduler-like system which respects the work load on the local machine.
Setting the hostname to <code>"localhost"</code> just strips out
<code>ssh</code> of the command issued.</li>
</ul>
</div>
<div class="section level3">
<h3 id="interface-changes">Interface Changes<a class="anchor" aria-label="anchor" href="#interface-changes"></a>
</h3>
<ul>
<li>batchtools remembers the last created or loaded Registry and sets it
as default registry. This way, you do not need to pass the registry
around anymore. If you need to work with multiple registries
simultaneously on the other hand, you can still do so by explicitly
passing registries to the functions.</li>
<li>Most functions now return a <a href="https://cran.r-project.org/package=data.table" class="external-link">data.table</a>
which is keyed with the <code>job.id</code>. This way, return values can
be joined together easily and efficient (see this <a href="https://mllg.github.io/batchtools/reference/JoinTables" class="external-link">help
page</a> for some examples).</li>
<li>The building blocks of a problem has been renamed from
<code>static</code> and <code>dynamic</code> to the more intuitive
<code>data</code> and <code>fun</code>. Thus, algorithm function should
have the formal arguments <code>job</code>, <code>data</code> and
<code>instance</code>.</li>
<li>The function <code>makeDesign</code> has been removed. Parameters
can be defined by just passing a <code>data.frame</code> or
<code>data.table</code> to <a href="https://mllg.github.io/batchtools/reference/addExperiments" class="external-link">addExperiments</a>.
For exhaustive designs, use <code><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">data.table::CJ()</a></code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="template-changes">Template changes<a class="anchor" aria-label="anchor" href="#template-changes"></a>
</h3>
<ul>
<li>The scheduler should directly execute the command:</li>
</ul>
<pre><code>Rscript -e 'batchtools::doJobCollection(&lt;filename&gt;)'</code></pre>
<p>There is no intermediate R source file like there was in
<code>BatchJobs</code>. * All information stored in the object <a href="https://mllg.github.io/batchtools/reference/JobCollection" class="external-link"><code>JobCollection</code></a>
can be accessed while brewing the template. * Extra variables may be
passed via the argument <code>resoures</code> of <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link">submitJobs</a>.</p>
</div>
<div class="section level3">
<h3 id="new-features">New features<a class="anchor" aria-label="anchor" href="#new-features"></a>
</h3>
<ul>
<li>Support for Docker Swarm via
<code>ClusterFunctionsDocker</code>.</li>
<li>Jobs can now be tagged and untagged to provide an easy way to group
them.</li>
<li>Some resources like the number of CPUs are now optionally passed to
<a href="https://cran.r-project.org/package=parallelMap" class="external-link">parallelMap</a>.
This eases nested parallelization, e.g. to use multicore parallelization
on the slave by just setting a resource on the master. See <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link">submitJobs()</a>
for an example.</li>
<li>
<code>ClusterFunctions</code> are now more flexible in general as
they can define hook functions which will be called at certain events.
<a href="https://github.com/mllg/batchtools/blob/master/R/clusterFunctionsDocker.R" class="external-link">ClusterFunctionsDocker</a>
is an example use case which implements a housekeeping routine. This
routine is called every time before a job is about to get submitted to
the scheduler (in the case: the Docker Swarm) via the hook
<code>pre.submit</code> and every time directly after the registry
synchronized jobs stored on the file system via the hook
<code>post.sync</code>.</li>
<li>More new features are covered in the <a href="https://mllg.github.io/batchtools/news/index.html" class="external-link">NEWS</a>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="porting-to-batchtools">Porting to <code>batchtools</code><a class="anchor" aria-label="anchor" href="#porting-to-batchtools"></a>
</h3>
<p>The following table assists in porting to batchtools by mapping
BatchJobs/BatchExperiments functions to their counterparts in
batchtools. The table does not cover functions which are (a) used only
internally in BatchJobs and (b) functions which have not been
renamed.</p>
<table class="table">
<colgroup>
<col width="46%">
<col width="53%">
</colgroup>
<thead><tr class="header">
<th>BatchJobs</th>
<th align="center">batchtools</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>addRegistryPackages</code></td>
<td align="center">Set <code>reg$packages</code> or
<code>reg$namespaces</code>, call <a href="https://mllg.github.io/batchtools/reference/saveRegistry" class="external-link">saveRegistry()</a>
</td>
</tr>
<tr class="even">
<td><code>addRegistrySourceDirs</code></td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td><code>addRegistrySourceFiles</code></td>
<td align="center">Set <code>reg$source</code>, call <a href="https://mllg.github.io/batchtools/reference/saveRegistry" class="external-link">saveRegistry()</a>
</td>
</tr>
<tr class="even">
<td><code>batchExpandGrid</code></td>
<td align="center">
<a href="https://mllg.github.io/batchtools/reference/batchMap" class="external-link">batchMap</a>:
<code>batchMap(..., args = CJ(x = 1:3, y = 1:10))</code>
</td>
</tr>
<tr class="odd">
<td><code>batchMapQuick</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/btlapply" class="external-link">btmapply</a></td>
</tr>
<tr class="even">
<td><code>batchReduceResults</code></td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td><code>batchUnexport</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/batchExport" class="external-link">batchExport</a></td>
</tr>
<tr class="even">
<td><code>filterResults</code></td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td><code>getJobIds</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/findJobs" class="external-link">findJobs</a></td>
</tr>
<tr class="even">
<td><code>getJobInfo</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/getJobTable" class="external-link">getJobStatus</a></td>
</tr>
<tr class="odd">
<td><code>getJob</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/JobExperiment" class="external-link">makeJob</a></td>
</tr>
<tr class="even">
<td><code>getJobParamDf</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/getJobTable" class="external-link">getJobPars</a></td>
</tr>
<tr class="odd">
<td><code>loadResults</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link">reduceResultsList</a></td>
</tr>
<tr class="even">
<td><code>reduceResultsDataFrame</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link">reduceResultsDataTable</a></td>
</tr>
<tr class="odd">
<td><code>reduceResultsMatrix</code></td>
<td align="center">
<a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link">reduceResultsList</a>
+ <code>do.call(rbind, res)</code>
</td>
</tr>
<tr class="even">
<td><code>reduceResultsVector</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link">reduceResultsDataTable</a></td>
</tr>
<tr class="odd">
<td><code>setJobFunction</code></td>
<td align="center">-</td>
</tr>
<tr class="even">
<td><code>setJobNames</code></td>
<td align="center">-</td>
</tr>
<tr class="odd">
<td><code>showStatus</code></td>
<td align="center"><a href="https://mllg.github.io/batchtools/reference/getStatus" class="external-link">getStatus</a></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="example-1-approximation-of-pi">Example 1: Approximation of <span class="math inline">\(\pi\)</span><a class="anchor" aria-label="anchor" href="#example-1-approximation-of-pi"></a>
</h2>
<p>To get a first insight into the usage of <code>batchtools</code>, we
start with an exemplary Monte Carlo simulation to approximate <span class="math inline">\(\pi\)</span>. For background information, see <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method" class="external-link">Wikipedia</a>.</p>
<p>First, a so-called registry object has to be created, which defines a
directory where all relevant information, files and results of the
computational jobs will be stored. There are two different types of
registry objects: First, a regular <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link"><code>Registry</code></a>
which we will use in this example. Second, an <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry" class="external-link"><code>ExperimentRegistry</code></a>
which provides an alternative way to define computational jobs and
thereby is tailored for a broad range of large scale computer
experiments. Here, we use a temporary registry which is stored in the
temp directory of the system and gets automatically deleted if you close
the R session.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeRegistry.html">makeRegistry</a></span><span class="op">(</span>file.dir <span class="op">=</span> <span class="cn">NA</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>For a permanent registry, set the <code>file.dir</code> to a valid
path. It can then be reused later, e.g., when you login to the system
again, by calling the function <code>loadRegistry(file.dir)</code>.</p>
<p>When a registry object is created or loaded, it is stored for the
active R session as the default. Therefore the argument <code>reg</code>
will be ignored in functions calls of this example, assuming the correct
registry is set as default. To get the current default registry, <a href="https://mllg.github.io/batchtools/reference/getDefaultRegistry" class="external-link"><code>getDefaultRegistry</code></a>
can be used. To switch to another registry, use <a href="https://mllg.github.io/batchtools/reference/getDefaultRegistry" class="external-link"><code>setDefaultRegistry()</code></a>.</p>
<p>First, we create a function which samples <span class="math inline">\(n\)</span> points <span class="math inline">\((x_i, y_i)\)</span> whereas <span class="math inline">\(x_i\)</span> and <span class="math inline">\(y_i\)</span> are distributed uniformly, i.e. <span class="math inline">\(x_i, y_i \sim \mathcal{U}(0,1)\)</span>. Next, the
distance to the origin <span class="math inline">\((0, 0)\)</span> is
calculated and the fraction of points in the unit circle (<span class="math inline">\(d \leq 1\)</span>) is returned.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piApprox</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">nums</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">nums</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">nums</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">d</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="fu">piApprox</span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.156</span></span></code></pre>
<p>We now parallelize <code>piApprox()</code> with
<code>batchtools</code>: We create 10 jobs, each doing a MC simulation
with <span class="math inline">\(10^5\)</span> jobs. We use <a href="https://mllg.github.io/batchtools/reference/batchMap" class="external-link"><code>batchMap()</code></a>
to define the jobs (note that this does not yet start the
calculation):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/batchMap.html">batchMap</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">piApprox</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1e5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding 10 jobs ...</span></span></code></pre>
<p>The length of the vector or list defines how many different jobs are
created, while the elements itself are used as arguments for the
function. The function <code>batchMap(fun, ...)</code> works analogously
to <code>Map(f, ...)</code> of the base package. An overview over the
jobs and their IDs can be retrieved with <a href="https://mllg.github.io/batchtools/reference/getJobTable" class="external-link"><code>getJobTable()</code></a>
which returns a data.frame with all relevant information:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="../reference/getJobTable.html">getJobTable</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "job.id"       "submitted"    "started"      "done"         "error"       </span></span>
<span><span class="co">##  [6] "mem.used"     "batch.id"     "log.file"     "job.hash"     "job.name"    </span></span>
<span><span class="co">## [11] "time.queued"  "time.running" "job.pars"     "resources"    "tags"</span></span></code></pre>
<p>Note that a unique job ID is assigned to each job. These IDs can be
used to restrict operations to subsets of jobs. To actually start the
calculation, call <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link"><code>submitJobs()</code></a>.
The registry and the selected job IDs can be taken as arguments as well
as an arbitrary list of resource requirements, which are to be handled
by the cluster back end.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/submitJobs.html">submitJobs</a></span><span class="op">(</span>resources <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>walltime <span class="op">=</span> <span class="fl">3600</span>, memory <span class="op">=</span> <span class="fl">1024</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Submitting 10 jobs in 10 chunks using cluster functions 'Interactive' ...</span></span></code></pre>
<p>In this example, a cap for the execution time (so-called walltime)
and for the maximum memory requirements are set. The progress of the
submitted jobs can be checked with <a href="https://mllg.github.io/batchtools/reference/getStatus" class="external-link"><code>getStatus()</code></a>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getStatus.html">getStatus</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Status for 10 jobs at 2025-05-22 15:49:38:</span></span>
<span><span class="co">##   Submitted    : 10 (100.0%)</span></span>
<span><span class="co">##   -- Queued    :  0 (  0.0%)</span></span>
<span><span class="co">##   -- Started   : 10 (100.0%)</span></span>
<span><span class="co">##   ---- Running :  0 (  0.0%)</span></span>
<span><span class="co">##   ---- Done    : 10 (100.0%)</span></span>
<span><span class="co">##   ---- Error   :  0 (  0.0%)</span></span>
<span><span class="co">##   ---- Expired :  0 (  0.0%)</span></span></code></pre>
<p>The resulting output includes the number of jobs in the registry, how
many have been submitted, have started to execute on the batch system,
are currently running, have successfully completed, and have terminated
due to an R exception. After jobs have successfully terminated, we can
load their results on the master. This can be done in a simple fashion
by using either <a href="https://mllg.github.io/batchtools/reference/loadResult" class="external-link"><code>loadResult()</code></a>,
which returns a single result exactly in the form it was calculated
during mapping, or by using <a href="https://mllg.github.io/batchtools/reference/reduceResults" class="external-link"><code>reduceResults()</code></a>,
which is a version of <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce()</a></code> from the base package for
registry objects.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/waitForJobs.html">waitForJobs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="va">loadResult</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.140652</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/reduceResults.html">reduceResults</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.140652</span></span></code></pre>
<p>If you are absolutely sure that your function works, you can take a
shortcut and use <em>batchtools</em> in an <code>lapply</code> fashion
using <a href="https://mllg.github.io/batchtools/reference/btlapply" class="external-link"><code>btlapply()</code></a>.
This function creates a temporary registry (but you may also pass one
yourself), calls <a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link"><code>batchMap()</code></a>,
wait for the jobs to terminate with <a href="https://mllg.github.io/batchtools/reference/waitForJobs" class="external-link"><code>waitForJobs()</code></a>
and then uses <a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link"><code>reduceResultsList()</code></a>
to return the results.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">=</span> <span class="fu"><a href="../reference/btlapply.html">btlapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1e5</span>, <span class="fl">10</span><span class="op">)</span>, <span class="va">piApprox</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.14124</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="example-2-machine-learning">Example 2: Machine Learning<a class="anchor" aria-label="anchor" href="#example-2-machine-learning"></a>
</h2>
<p>We stick to a rather simple, but not unrealistic example to explain
some further functionalities: Applying two classification learners to
the famous iris data set (Anderson 1935), vary a few hyperparameters and
evaluate the effect on the classification performance.</p>
<p>First, we create a registry, the central meta-data object which
records technical details and the setup of the experiments. We use an <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry" class="external-link"><code>ExperimentRegistry</code></a>
where the job definition is split into creating problems and algorithms.
See the paper on <a href="https://www.jstatsoft.org/article/view/v064i11" class="external-link">BatchJobs and
BatchExperiments</a> for a detailed explanation. Again, we use a
temporary registry and make it the default registry.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/batchtools" class="external-link">batchtools</a></span><span class="op">)</span></span>
<span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeExperimentRegistry.html">makeExperimentRegistry</a></span><span class="op">(</span>file.dir <span class="op">=</span> <span class="cn">NA</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="problems-and-algorithms">Problems and Algorithms<a class="anchor" aria-label="anchor" href="#problems-and-algorithms"></a>
</h3>
<p>By adding a problem to the registry, we can define the data on which
certain computational jobs shall work. This can be a matrix, data frame
or array that always stays the same for all subsequent experiments. But
it can also be of a more dynamic nature, e.g., subsamples of a dataset
or random numbers drawn from a probability distribution . Therefore the
function <a href="https://mllg.github.io/batchtools/reference/addProblem" class="external-link"><code>addProblem()</code></a>
accepts static parts in its <code>data</code> argument, which is passed
to the argument <code>fun</code> which generates a (possibly stochastic)
problem instance. For <code>data</code>, any R object can be used. If
only <code>data</code> is given, the generated instance is
<code>data</code>. The argument <code>fun</code> has to be a function
with the arguments <code>data</code> and <code>job</code> (and
optionally other arbitrary parameters). The argument <code>job</code> is
an object of type <a href="https://mllg.github.io/batchtools/reference/JobExperiment" class="external-link"><code>Job</code></a>
which holds additional information about the job.</p>
<p>We want to split the iris data set into a training set and test set.
In this example we use use subsampling which just randomly takes a
fraction of the observations as training set. We define a problem
function which returns the indices of the respective training and test
set for a split with <code>100 * ratio</code>% of the observations being
in the test set:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subsample</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">job</span>, <span class="va">ratio</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">n</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="va">ratio</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">test</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">train</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>test <span class="op">=</span> <span class="va">test</span>, train <span class="op">=</span> <span class="va">train</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><a href="https://mllg.github.io/batchtools/reference/addProblem" class="external-link"><code>addProblem()</code></a>
files the problem to the file system and the problem gets recorded in
the registry.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"iris"</span>, package <span class="op">=</span> <span class="st">"datasets"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/addProblem.html">addProblem</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"iris"</span>, data <span class="op">=</span> <span class="va">iris</span>, fun <span class="op">=</span> <span class="va">subsample</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding problem 'iris'</span></span></code></pre>
<p>The function call will be evaluated at a later stage on the workers.
In this process, the <code>data</code> part will be loaded and passed to
the function. Note that we set a problem seed to synchronize the
experiments in the sense that the same resampled training and test sets
are used for the algorithm comparison in each distinct replication.</p>
<p>The algorithms for the jobs are added to the registry in a similar
manner. When using <a href="https://mllg.github.io/batchtools/reference/addAlgorithm" class="external-link"><code>addAlgorithm()</code></a>,
an identifier as well as the algorithm to apply to are required
arguments. The algorithm must be given as a function with arguments
<code>job</code>, <code>data</code> and <code>instance</code>. Further
arbitrary arguments (e.g., hyperparameters or strategy parameters) may
be defined analogously as for the function in <code>addProblem</code>.
The objects passed to the function via <code>job</code> and
<code>data</code> are here the same as above, while via
<code>instance</code> the return value of the evaluated problem function
is passed. The algorithm can return any R object which will
automatically be stored on the file system for later retrieval. Firstly,
we create an algorithm which applies a support vector machine:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">svm.wrapper</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">job</span>, <span class="va">instance</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"e1071"</span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html" class="external-link">svm</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">train</span>, <span class="op">]</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">test</span>, <span class="op">]</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Species</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">test</span><span class="op">]</span>, <span class="va">pred</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/addAlgorithm.html">addAlgorithm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"svm"</span>, fun <span class="op">=</span> <span class="va">svm.wrapper</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding algorithm 'svm'</span></span></code></pre>
<p>Secondly, a random forest of classification trees:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest.wrapper</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">job</span>, <span class="va">instance</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://imbs-hl.github.io/ranger/" class="external-link">"ranger"</a></span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">=</span> <span class="fu"><a href="http://imbs-hl.github.io/ranger/reference/ranger.html" class="external-link">ranger</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">train</span>, <span class="op">]</span>, write.forest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">test</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">Species</span><span class="op">[</span><span class="va">instance</span><span class="op">$</span><span class="va">test</span><span class="op">]</span>, <span class="va">pred</span><span class="op">$</span><span class="va">predictions</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/addAlgorithm.html">addAlgorithm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"forest"</span>, fun <span class="op">=</span> <span class="va">forest.wrapper</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding algorithm 'forest'</span></span></code></pre>
<p>Both algorithms return a confusion matrix for the predictions on the
test set, which will later be used to calculate the misclassification
rate.</p>
<p>Note that using the <code>...</code> argument in the wrapper
definitions allows us to circumvent naming specific design parameters
for now. This is an advantage if we later want to extend the set of
algorithm parameters in the experiment. The algorithms get recorded in
the registry and the corresponding functions are stored on the file
system.</p>
<p>Defined problems and algorithms can be queried with:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span><span class="op">$</span><span class="va">problems</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "iris"</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reg</span><span class="op">$</span><span class="va">algorithms</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "svm"    "forest"</span></span></code></pre>
<p>The flow to define experiments is summarized in the following
figure:</p>
<p><img src="tikz_prob_algo_simple.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="creating-jobs">Creating jobs<a class="anchor" aria-label="anchor" href="#creating-jobs"></a>
</h3>
<p><a href="https://mllg.github.io/batchtools/reference/addExperiments" class="external-link"><code>addExperiments()</code></a>
is used to parametrize the jobs and thereby define computational jobs.
To do so, you have to pass named lists of parameters to <a href="https://mllg.github.io/batchtools/reference/addExperiments" class="external-link"><code>addExperiments()</code></a>.
The elements of the respective list (one for problems and one for
algorithms) must be named after the problem or algorithm they refer to.
The data frames contain parameter constellations for the problem or
algorithm function where columns must have the same names as the target
arguments. When the problem design and the algorithm design are combined
in <a href="https://mllg.github.io/batchtools/reference/addExperiments" class="external-link"><code>addExperiments()</code></a>,
each combination of the parameter sets of the two designs defines a
distinct job. How often each of these jobs should be computed can be
determined with the argument <code>repls</code>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># problem design: try two values for the ratio parameter</span></span>
<span><span class="va">pdes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>iris <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.67</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># algorithm design: try combinations of kernel and epsilon exhaustively,</span></span>
<span><span class="co"># try different number of trees for the forest</span></span>
<span><span class="va">ades</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  svm <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/J.html" class="external-link">CJ</a></span><span class="op">(</span>kernel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"polynomial"</span>, <span class="st">"radial"</span><span class="op">)</span>, epsilon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  forest <span class="op">=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ntree <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/addExperiments.html">addExperiments</a></span><span class="op">(</span><span class="va">pdes</span>, <span class="va">ades</span>, repls <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding 60 experiments ('iris'[2] x 'svm'[6] x repls[5]) ...</span></span></code></pre>
<pre><code><span><span class="co">## Adding 30 experiments ('iris'[2] x 'forest'[3] x repls[5]) ...</span></span></code></pre>
<p>The jobs are now available in the registry with an individual job ID
for each. The function <a href="https://mllg.github.io/batchtools/reference/summarizeExperiments" class="external-link"><code>summarizeExperiments()</code></a>
returns a table which gives a quick overview over all defined
experiments.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/summarizeExperiments.html">summarizeExperiments</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    problem algorithm .count</span></span>
<span><span class="co">##     &lt;char&gt;    &lt;char&gt;  &lt;int&gt;</span></span>
<span><span class="co">## 1:    iris       svm     60</span></span>
<span><span class="co">## 2:    iris    forest     30</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/summarizeExperiments.html">summarizeExperiments</a></span><span class="op">(</span>by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"problem"</span>, <span class="st">"algorithm"</span>, <span class="st">"ratio"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    problem algorithm ratio .count</span></span>
<span><span class="co">##     &lt;char&gt;    &lt;char&gt; &lt;num&gt;  &lt;int&gt;</span></span>
<span><span class="co">## 1:    iris       svm  0.67     30</span></span>
<span><span class="co">## 2:    iris       svm  0.90     30</span></span>
<span><span class="co">## 3:    iris    forest  0.67     15</span></span>
<span><span class="co">## 4:    iris    forest  0.90     15</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="before-submitting">Before Submitting<a class="anchor" aria-label="anchor" href="#before-submitting"></a>
</h3>
<p>Before submitting all jobs to the batch system, we encourage you to
test each algorithm individually. Or sometimes you want to submit only a
subset of experiments because the jobs vastly differ in runtime. Another
reoccurring task is the collection of results for only a subset of
experiments. For all these use cases, <a href="https://mllg.github.io/batchtools/reference/findJobs" class="external-link"><code>findExperiments()</code></a>
can be employed to conveniently select a particular subset of jobs. It
returns the IDs of all experiments that match the given criteria. Your
selection can depend on substring matches of problem or algorithm IDs
using <code>prob.name</code> or <code>algo.name</code>, respectively.
You can also pass R expressions, which will be evaluated in your problem
parameter setting (<code>prob.pars</code>) or algorithm parameter
setting (<code>algo.pars</code>). The expression is then expected to
evaluate to a Boolean value. Furthermore, you can restrict the
experiments to specific replication numbers.</p>
<p>To illustrate <a href="https://mllg.github.io/batchtools/reference/findJobs" class="external-link"><code>findExperiments()</code></a>,
we will select two experiments, one with a support vector machine and
the other with a random forest and the parameter
<code>ntree = 1000</code>. The selected experiment IDs are then passed
to testJob.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/findJobs.html">findExperiments</a></span><span class="op">(</span>algo.name <span class="op">=</span> <span class="st">"svm"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">id1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id</span></span>
<span><span class="co">##     &lt;int&gt;</span></span>
<span><span class="co">## 1:      1</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/findJobs.html">findExperiments</a></span><span class="op">(</span>algo.name <span class="op">=</span> <span class="st">"forest"</span>, algo.pars <span class="op">=</span> <span class="op">(</span><span class="va">ntree</span> <span class="op">==</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">id2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id</span></span>
<span><span class="co">##     &lt;int&gt;</span></span>
<span><span class="co">## 1:     71</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/testJob.html">testJob</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ### [bt]: Generating problem instance for problem 'iris' ...</span></span>
<span><span class="co">## ### [bt]: Applying algorithm 'svm' on problem 'iris' for job 1 (seed = 2) ...</span></span></code></pre>
<pre><code><span><span class="co">##             pred</span></span>
<span><span class="co">##              setosa versicolor virginica</span></span>
<span><span class="co">##   setosa         13          0         0</span></span>
<span><span class="co">##   versicolor      0         17         0</span></span>
<span><span class="co">##   virginica       0          1        19</span></span></code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/testJob.html">testJob</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ### [bt]: Generating problem instance for problem 'iris' ...</span></span>
<span><span class="co">## ### [bt]: Applying algorithm 'forest' on problem 'iris' for job 71 (seed = 72) ...</span></span></code></pre>
<pre><code><span><span class="co">##             </span></span>
<span><span class="co">##              setosa versicolor virginica</span></span>
<span><span class="co">##   setosa         13          0         0</span></span>
<span><span class="co">##   versicolor      0         16         1</span></span>
<span><span class="co">##   virginica       0          1        19</span></span></code></pre>
<p>If something goes wrong, <code>batchtools</code> comes with a bunch
of useful debugging utilities (see separate vignette on error handling).
If everything turns out fine, we can proceed with the calculation.</p>
</div>
<div class="section level3">
<h3 id="submitting-and-collecting-results">Submitting and Collecting Results<a class="anchor" aria-label="anchor" href="#submitting-and-collecting-results"></a>
</h3>
<p>To submit the jobs, we call <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link"><code>submitJobs()</code></a>
and wait for all jobs to terminate using <a href="https://mllg.github.io/batchtools/reference/waitForJobs" class="external-link"><code>waitForJobs()</code></a>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/submitJobs.html">submitJobs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Submitting 90 jobs in 90 chunks using cluster functions 'Interactive' ...</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/waitForJobs.html">waitForJobs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>After jobs are finished, the results can be collected with <a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link"><code>reduceResultsDataTable()</code></a>
where we directly extract the mean misclassification error:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reduce</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mce <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="../reference/unwrap.html">unwrap</a></span><span class="op">(</span><span class="fu"><a href="../reference/reduceResultsList.html">reduceResultsDataTable</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">reduce</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id   mce</span></span>
<span><span class="co">##     &lt;int&gt; &lt;num&gt;</span></span>
<span><span class="co">## 1:      1  0.02</span></span>
<span><span class="co">## 2:      2  0.00</span></span>
<span><span class="co">## 3:      3  0.04</span></span>
<span><span class="co">## 4:      4  0.06</span></span>
<span><span class="co">## 5:      5  0.02</span></span>
<span><span class="co">## 6:      6  0.02</span></span></code></pre>
<p>Next, we merge the results table with the table of job parameters
using one of the <a href="https://mllg.github.io/batchtools/reference/JoinTables" class="external-link">join
helpers</a> provided by <code>batchtools</code> (here, we use an inner
join):</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">=</span> <span class="fu"><a href="../reference/unwrap.html">unwrap</a></span><span class="op">(</span><span class="fu"><a href="../reference/getJobTable.html">getJobPars</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tab</span> <span class="op">=</span> <span class="fu"><a href="../reference/JoinTables.html">ijoin</a></span><span class="op">(</span><span class="va">pars</span>, <span class="va">results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id problem algorithm ratio kernel epsilon ntree   mce</span></span>
<span><span class="co">##     &lt;int&gt;  &lt;char&gt;    &lt;char&gt; &lt;num&gt; &lt;char&gt;   &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">## 1:      1    iris       svm  0.67 linear    0.01    NA  0.02</span></span>
<span><span class="co">## 2:      2    iris       svm  0.67 linear    0.01    NA  0.00</span></span>
<span><span class="co">## 3:      3    iris       svm  0.67 linear    0.01    NA  0.04</span></span>
<span><span class="co">## 4:      4    iris       svm  0.67 linear    0.01    NA  0.06</span></span>
<span><span class="co">## 5:      5    iris       svm  0.67 linear    0.01    NA  0.02</span></span>
<span><span class="co">## 6:      6    iris       svm  0.67 linear    0.10    NA  0.02</span></span></code></pre>
<p>We now aggregate the results group-wise. You can use <a href="https://cran.r-project.org/package=data.table" class="external-link"><code>data.table</code></a>,
<code>base::aggregate()</code>, or the <a href="https://cran.r-project.org/package=dplyr" class="external-link"><code>dplyr</code></a>
package for this purpose. Here, we use <a href="https://cran.r-project.org/package=data.table" class="external-link"><code>data.table</code></a>
to subset the table to jobs where the ratio is <code>0.67</code> and
group by algorithm the algorithm hyperparameters:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab</span><span class="op">[</span><span class="va">ratio</span> <span class="op">==</span> <span class="fl">0.67</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mmce <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mce</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"algorithm"</span>, <span class="st">"kernel"</span>, <span class="st">"epsilon"</span>, <span class="st">"ntree"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##    algorithm     kernel epsilon ntree  mmce</span></span>
<span><span class="co">##       &lt;char&gt;     &lt;char&gt;   &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span><span class="co">## 1:       svm     linear    0.01    NA 0.028</span></span>
<span><span class="co">## 2:       svm     linear    0.10    NA 0.028</span></span>
<span><span class="co">## 3:       svm polynomial    0.01    NA 0.096</span></span>
<span><span class="co">## 4:       svm polynomial    0.10    NA 0.096</span></span>
<span><span class="co">## 5:       svm     radial    0.01    NA 0.044</span></span>
<span><span class="co">## 6:       svm     radial    0.10    NA 0.044</span></span>
<span><span class="co">## 7:    forest       &lt;NA&gt;      NA   100 0.044</span></span>
<span><span class="co">## 8:    forest       &lt;NA&gt;      NA   500 0.048</span></span>
<span><span class="co">## 9:    forest       &lt;NA&gt;      NA  1000 0.044</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="example-error-handling">Example: Error Handling<a class="anchor" aria-label="anchor" href="#example-error-handling"></a>
</h2>
<p>In any large scale experiment many things can and will go wrong. The
cluster might have an outage, jobs may run into resource limits or
crash, subtle bugs in your code could be triggered or any other error
condition might arise. In these situations it is important to quickly
determine what went wrong and to recompute only the minimal number of
required jobs.</p>
<p>Therefore, before you submit anything you should use <a href="https://mllg.github.io/batchtools/reference/testJob" class="external-link"><code>testJob()</code></a>
to catch errors that are easy to spot because they are raised in many or
all jobs. If <code>external</code> is set, this function runs the job
without side effects in an independent R process on your local machine
via <code>Rscript</code> similar as on the slave, redirects the output
of the process to your R console, loads the job result and returns it.
If you do not set <code>external</code>, the job is executed is in the
currently running R session, with the drawback that you might be unable
to catch missing variable declarations or missing package
dependencies.</p>
<p>By way of illustration here is a small example. First, we create a
temporary registry.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlr-org/batchtools" class="external-link">batchtools</a></span><span class="op">)</span></span>
<span><span class="va">reg</span> <span class="op">=</span> <span class="fu"><a href="../reference/makeRegistry.html">makeRegistry</a></span><span class="op">(</span>file.dir <span class="op">=</span> <span class="cn">NA</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Ten jobs are created, one will trow a warning and two of them will
raise an exception.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flakeyFunction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Just a simple warning"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">value</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">9</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Ooops."</span><span class="op">)</span></span>
<span>  <span class="va">value</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/batchMap.html">batchMap</a></span><span class="op">(</span><span class="va">flakeyFunction</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Adding 10 jobs ...</span></span></code></pre>
<p>Now that the jobs are defined, we can test jobs independently:</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/testJob.html">testJob</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ### [bt]: Setting seed to 2 ...</span></span></code></pre>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>In this case, testing the job with ID = 1 provides the appropriate
result but testing the job with ID = 2 leads to an error:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/testJob.html">testJob</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ### [bt]: Setting seed to 3 ...</span></span>
<span><span class="co">## Error in (function (value)  : Ooops.</span></span></code></pre>
<pre><code><span><span class="co">## [1] "Error in (function (value)  : Ooops.\n"</span></span></code></pre>
<p>We ignore the error here, and just assume everything looks fine and
submit all jobs.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/submitJobs.html">submitJobs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Submitting 10 jobs in 10 chunks using cluster functions 'Interactive' ...</span></span></code></pre>
<pre><code><span><span class="co">## Error in (function (value)  : Ooops.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in (function (value) : Just a simple warning</span></span></code></pre>
<pre><code><span><span class="co">## Error in (function (value)  : Ooops.</span></span></code></pre>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/waitForJobs.html">waitForJobs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p>After you have submitted jobs and suspect that something is going
wrong, the first thing to do is to run <a href="https://mllg.github.io/batchtools/reference/getStatus" class="external-link"><code>getStatus()</code></a>
to display a summary of the current state of the system.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getStatus.html">getStatus</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Status for 10 jobs at 2025-05-22 15:49:42:</span></span>
<span><span class="co">##   Submitted    : 10 (100.0%)</span></span>
<span><span class="co">##   -- Queued    :  0 (  0.0%)</span></span>
<span><span class="co">##   -- Started   : 10 (100.0%)</span></span>
<span><span class="co">##   ---- Running :  0 (  0.0%)</span></span>
<span><span class="co">##   ---- Done    :  8 ( 80.0%)</span></span>
<span><span class="co">##   ---- Error   :  2 ( 20.0%)</span></span>
<span><span class="co">##   ---- Expired :  0 (  0.0%)</span></span></code></pre>
<p>The status message shows that two of the jobs could not be executed
successfully. To get the IDs of all jobs that failed due to an error we
can use <a href="https://mllg.github.io/batchtools/reference/findJobs" class="external-link"><code>findErrors()</code></a>
and to retrieve the actual error message, we can use <a href="https://mllg.github.io/batchtools/reference/getErrorMessages" class="external-link"><code>getErrorMessages()</code></a>.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/findJobs.html">findErrors</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id</span></span>
<span><span class="co">##     &lt;int&gt;</span></span>
<span><span class="co">## 1:      2</span></span>
<span><span class="co">## 2:      9</span></span></code></pre>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getErrorMessages.html">getErrorMessages</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;job.id&gt;</span></span>
<span><span class="co">##    job.id terminated  error                              message</span></span>
<span><span class="co">##     &lt;int&gt;     &lt;lgcl&gt; &lt;lgcl&gt;                               &lt;char&gt;</span></span>
<span><span class="co">## 1:      2       TRUE   TRUE Error in (function (value)  : Ooops.</span></span>
<span><span class="co">## 2:      9       TRUE   TRUE Error in (function (value)  : Ooops.</span></span></code></pre>
<p>If we want to peek into the R log file of a job to see more context
for the error we can use <a href="https://mllg.github.io/batchtools/reference/showLog" class="external-link"><code>showLog()</code></a>
which opens a pager or use <a href="https://mllg.github.io/batchtools/reference/showLog" class="external-link"><code>getLog()</code></a>
to get the log as character vector:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="../reference/showLog.html">getLog</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "### [bt]: Memory measurement disabled"                           </span></span>
<span><span class="co">## [2] "### [bt]: Starting job [batchtools job.id=9]"                    </span></span>
<span><span class="co">## [3] "### [bt]: Setting seed to 10 ..."                                </span></span>
<span><span class="co">## [4] ""                                                                </span></span>
<span><span class="co">## [5] "### [bt]: Job terminated with an exception [batchtools job.id=9]"</span></span>
<span><span class="co">## [6] "### [bt]: Calculation finished!"</span></span></code></pre>
<p>You can also grep for messages (output suppressed in this vignette
for technical reasons):</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/grepLogs.html">grepLogs</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"simple"</span>, ignore.case <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="workflow">Workflow<a class="anchor" aria-label="anchor" href="#workflow"></a>
</h2>
<div class="section level3">
<h3 id="on-the-local-system">On the Local System<a class="anchor" aria-label="anchor" href="#on-the-local-system"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Create a Registry with <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link"><code>makeRegistry()</code></a>
(or <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry" class="external-link"><code>makeExperimentRegistry()</code></a>)
or load an existing from the file system with <a href="https://mllg.github.io/batchtools/reference/loadRegistry" class="external-link"><code>loadRegistry()</code></a>.</li>
<li>Define computational jobs with <a href="https://mllg.github.io/batchtools/reference/batchMap" class="external-link"><code>batchMap()</code></a>
or <a href="https://mllg.github.io/batchtools/reference/batchReduce" class="external-link"><code>batchReduce()</code></a>
if you used <a href="https://mllg.github.io/batchtools/reference/makeRegistry" class="external-link"><code>makeRegistry()</code></a>
or define with <a href="https://mllg.github.io/batchtools/reference/addAlgorithm" class="external-link"><code>addAlgorithm()</code></a>,
<a href="https://mllg.github.io/batchtools/reference/addProblem" class="external-link"><code>addProblem()</code></a>
and <a href="https://mllg.github.io/batchtools/reference/addExperiments" class="external-link"><code>addExperiments()</code></a>
if you started with <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry" class="external-link"><code>makeExperimentRegistry()</code></a>.
It is advised to test some jobs with <a href="https://mllg.github.io/batchtools/reference/testJob" class="external-link"><code>testJob()</code></a>
in the interactive session and with
<code>testJob(external = TRUE)</code> in a separate R process. Note that
you can add additional jobs if you are using an <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry" class="external-link"><code>ExperimentRegistry</code></a>.</li>
<li>If required, query the data base for job ids depending on their
status, parameters or tags (see <a href="https://mllg.github.io/batchtools/reference/findJobs" class="external-link"><code>findJobs()</code></a>).
The returned tables can easily be combined in a set-like fashion with
data base verbs: union (<a href="https://mllg.github.io/batchtools/reference/JoinTables" class="external-link"><code>ojoin()</code></a>
for outer join), intersect (<a href="https://mllg.github.io/batchtools/reference/JoinTables" class="external-link"><code>ijoin()</code></a>
for inner join), difference (<a href="https://mllg.github.io/batchtools/reference/JoinTables" class="external-link"><code>ajoin()</code></a>
for anti join).</li>
<li>Submit jobs with <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link"><code>submitJobs()</code></a>.
You can specify job resources here. If you have thousands of fast
terminating jobs, you want to <a href="https://mllg.github.io/batchtools/reference/chunk" class="external-link"><code>chunk()</code></a>
them first. If some jobs already terminated, you can estimate the
runtimes with <a href="https://mllg.github.io/batchtools/reference/estimateRuntimes" class="external-link"><code>estimateRuntimes()</code></a>
and chunk jobs into heterogeneous groups with <a href="https://mllg.github.io/batchtools/reference/chunk" class="external-link"><code>lpt()</code></a>
and <a href="https://mllg.github.io/batchtools/reference/chunk" class="external-link"><code>binpack()</code></a>.</li>
<li>Monitor jobs. <a href="https://mllg.github.io/batchtools/reference/getStatus" class="external-link"><code>getStatus()</code></a>
gives a summarizing overview. Use <a href="https://mllg.github.io/batchtools/reference/showLog" class="external-link"><code>showLog()</code></a>
and <a href="https://mllg.github.io/batchtools/reference/grepLogs" class="external-link"><code>grepLogs()</code></a>
to investigate log file. Run jobs in the currently running session with
<a href="https://mllg.github.io/batchtools/reference/testJob" class="external-link"><code>testJob()</code></a>
to get a <code><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback()</a></code>.</li>
<li>Collect (partial) results. <a href="https://mllg.github.io/batchtools/reference/loadResult" class="external-link"><code>loadResult()</code></a>
retrieves a single result from the file system. <a href="https://mllg.github.io/batchtools/reference/reduceResults" class="external-link"><code>reduceResults()</code></a>
mimics <code><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce()</a></code> and allows to apply a function to many
files in an iterative fashion. <a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link"><code>reduceResultsList()</code></a>
and <a href="https://mllg.github.io/batchtools/reference/reduceResultsList" class="external-link"><code>reduceResultsDataTable()</code></a>
collect results into a <code>list</code> or <code>data.table</code>,
respectively.</li>
</ol>
<p><img src="function_overview.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="on-multiple-systems">On Multiple Systems<a class="anchor" aria-label="anchor" href="#on-multiple-systems"></a>
</h3>
<p>Most users develop and prototype their experiments on a desktop box
in their preferred IDE and later deploy to a large computing cluster.
This can be done by prototyping locally (<a href="https://mllg.github.io/batchtools/reference/testJob" class="external-link"><code>testJob()</code></a>
or submit subsets via <a href="https://mllg.github.io/batchtools/reference/submitJobs" class="external-link"><code>submitJobs()</code></a>).
To deploy to the cluster, just copy the file directory (as reported by
<code>reg$file.dir</code>) to the remote system. Next, log in on the
cluster (typically via <code>ssh</code>), <code>cd</code> to the copied
directory and call
<code>loadRegistry("&lt;file.dir.on.remote"&gt;, "&lt;work.dir.on.remote&gt;", writeable = TRUE)</code>.
This function will (a) source the local configuration file so that you
can talk to the cluster (verify by checking the output of
<code>reg$cluster.functions</code>) and (b) adjust the paths to the new
system if argument <code>update.paths</code> is set. After loading the
Registry, it is advised to test some jobs again with <a href="https://mllg.github.io/batchtools/reference/testJob" class="external-link"><code>testJob()</code></a>
before submitting all of them with
<code>submitJobs(resources = list())</code> (remember you now need to
set resources!). After some jobs are finished, the <code>file.dir</code>
can be copied back (do not merge with the previous directory!) and
loaded again with <a href="https://mllg.github.io/batchtools/reference/loadRegistry" class="external-link"><code>loadRegistry()</code></a>.</p>
<p>This approach is totally viable as long as some general rules are
followed:</p>
<ol style="list-style-type: decimal">
<li>Make sure you have all packages installed. Package versions can be
synchronized across machines with <a href="https://cran.r-project.org/package=checkpoint" class="external-link"><code>checkpoint</code></a>
or <a href="https://cran.r-project.org/package=packrat" class="external-link"><code>packrat</code></a>.</li>
<li>Test jobs on the remote system prior to submit to ensure that paths
are resolved correctly.</li>
<li>Make sure you have set the cluster functions in a configuration
file, and stick to one backend as long as jobs are running.</li>
<li>The status can only be monitored on the remote system (for obvious
reasons).</li>
<li>Partial results can be inspected both on the remote system and on
the local system. For the latter, you need to copy over the
<strong>complete</strong> <code>file.dir</code> first.
Overwriting/merging directories is not advised as this may lead to
inconsistencies if you added or removed experiments on the remote. If
you have to merge, use <code>rsync</code> with option
<code>--delete</code>. Load the registry locally with <a href="https://mllg.github.io/batchtools/reference/loadRegistry" class="external-link"><code>loadRegistry()</code></a>
and collect results. Do not copy back and forth.</li>
<li>Avoid accessing the <code>file.dir</code> with multiple sessions
simultaneously. This includes accessing the registry via a mount!
Simultaneous access may lead to inconsistencies and missing
results.</li>
</ol>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michel Lang, Bernd Bischl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
