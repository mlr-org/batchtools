<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Submit Jobs to the Batch Systems — submitJobs • batchtools</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Submit Jobs to the Batch Systems — submitJobs" />
<meta property="og:description" content="Submits defined jobs to the batch system.
After submitting the jobs, you can use waitForJobs to wait for the
termination of jobs or call reduceResultsList/reduceResults
to collect partial results.
The progress can be monitored with getStatus." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">batchtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.14</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/batchtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mllg/batchtools/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Submit Jobs to the Batch Systems</h1>
    <small class="dont-index">Source: <a href='https://github.com/mllg/batchtools/blob/master/R/submitJobs.R'><code>R/submitJobs.R</code></a></small>
    <div class="hidden name"><code>submitJobs.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Submits defined jobs to the batch system.</p>
<p>After submitting the jobs, you can use <code><a href='waitForJobs.html'>waitForJobs</a></code> to wait for the
termination of jobs or call <code><a href='reduceResultsList.html'>reduceResultsList</a></code>/<code><a href='reduceResults.html'>reduceResults</a></code>
to collect partial results.
The progress can be monitored with <code><a href='getStatus.html'>getStatus</a></code>.</p>
    </div>

    <pre class="usage"><span class='fu'>submitJobs</span><span class='op'>(</span>
  ids <span class='op'>=</span> <span class='cn'>NULL</span>,
  resources <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span>,
  sleep <span class='op'>=</span> <span class='cn'>NULL</span>,
  reg <span class='op'>=</span> <span class='fu'><a href='getDefaultRegistry.html'>getDefaultRegistry</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>ids</th>
      <td><p>[<code><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></code> or <code>integer</code>]<br />
A <code><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></code> (or <code><a href='https://Rdatatable.gitlab.io/data.table/reference/data.table.html'>data.table</a></code>)
with a column named &#8220;job.id&#8221;.
Alternatively, you may also pass a vector of integerish job ids.
If not set, defaults to the return value of <code><a href='findJobs.html'>findNotSubmitted</a></code>.
Invalid ids are ignored.</p></td>
    </tr>
    <tr>
      <th>resources</th>
      <td><p>[<code>named list</code>]<br />
Computational  resources for the jobs to submit. The actual elements of this list
(e.g. something like &#8220;walltime&#8221; or &#8220;nodes&#8221;) depend on your template file, exceptions are outlined in the section 'Resources'.
Default settings for a system can be set in the configuration file by defining the named list <code>default.resources</code>.
Note that these settings are merged by name, e.g. merging <code><a href='https://rdrr.io/r/base/list.html'>list(walltime = 300)</a></code> into <code><a href='https://rdrr.io/r/base/list.html'>list(walltime = 400, memory = 512)</a></code>
will result in <code><a href='https://rdrr.io/r/base/list.html'>list(walltime = 300, memory = 512)</a></code>.
Same holds for individual job resources passed as additional column of <code>ids</code> (c.f. section 'Resources').</p></td>
    </tr>
    <tr>
      <th>sleep</th>
      <td><p>[<code>function(i)</code> | <code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code>]<br />
Parameter to control the duration to sleep between temporary errors.
You can pass an absolute numeric value in seconds or a <code>function(i)</code> which returns the number of seconds to sleep in the <code>i</code>-th
iteration between temporary errors.
If not provided (<code>NULL</code>), tries to read the value (number/function) from the configuration file (stored in <code>reg$sleep</code>) or defaults to
a function with exponential backoff between 5 and 120 seconds.</p></td>
    </tr>
    <tr>
      <th>reg</th>
      <td><p>[<code><a href='makeRegistry.html'>Registry</a></code>]<br />
Registry. If not explicitly passed, uses the default registry (see <code><a href='getDefaultRegistry.html'>setDefaultRegistry</a></code>).</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>[<code><a href='https://Rdatatable.gitlab.io/data.table/reference/data.table.html'>data.table</a></code>] with columns &#8220;job.id&#8221; and &#8220;chunk&#8221;.</p>
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>If you a large number of jobs, disabling the progress bar (<code><a href='https://rdrr.io/r/base/options.html'>options(batchtools.progress = FALSE)</a></code>)
can significantly increase the performance of <code>submitJobs</code>.</p>
    <h2 class="hasAnchor" id="resources"><a class="anchor" href="#resources"></a>Resources</h2>

    

<p>You can pass arbitrary resources to <code>submitJobs()</code> which then are available in the cluster function template.
Some resources' names are standardized and it is good practice to stick to the following nomenclature to avoid confusion:</p><dl>
 <dt>walltime:</dt><dd><p>Upper time limit in seconds for jobs before they get killed by the scheduler. Can be passed as additional column as part of <code>ids</code> to set per-job resources.</p></dd>
 <dt>memory:</dt><dd><p>Memory limit in Mb. If jobs exceed this limit, they are usually killed by the scheduler. Can be passed as additional column as part of <code>ids</code> to set per-job resources.</p></dd>
 <dt>ncpus:</dt><dd><p>Number of (physical) CPUs to use on the slave. Can be passed as additional column as part of <code>ids</code> to set per-job resources.</p></dd>
 <dt>omp.threads:</dt><dd><p>Number of threads to use via OpenMP. Used to set environment variable &#8220;OMP_NUM_THREADS&#8221;. Can be passed as additional column as part of <code>ids</code> to set per-job resources.</p></dd>
 <dt>pp.size:</dt><dd><p>Maximum size of the pointer protection stack, see <code><a href='https://rdrr.io/r/base/Memory.html'>Memory</a></code>.</p></dd>
 <dt>blas.threads:</dt><dd><p>Number of threads to use for the BLAS backend. Used to set environment variables &#8220;MKL_NUM_THREADS&#8221; and &#8220;OPENBLAS_NUM_THREADS&#8221;. Can be passed as additional column as part of <code>ids</code> to set per-job resources.</p></dd>
 <dt>measure.memory:</dt><dd><p>Enable memory measurement for jobs. Comes with a small runtime overhead.</p></dd>
 <dt>chunks.as.arrayjobs:</dt><dd><p>Execute chunks as array jobs.</p></dd>
 <dt>pm.backend:</dt><dd><p>Start a <span class="pkg">parallelMap</span> backend on the slave.</p></dd>
 <dt>foreach.backend:</dt><dd><p>Start a <span class="pkg">foreach</span> backend on the slave.</p></dd>
 <dt>clusters:</dt><dd><p>Resource used for Slurm to select the set of clusters to run <code>sbatch</code>/<code>squeue</code>/<code>scancel</code> on.</p></dd>

</dl>

    <h2 class="hasAnchor" id="chunking-of-jobs"><a class="anchor" href="#chunking-of-jobs"></a>Chunking of Jobs</h2>

    

<p>Multiple jobs can be grouped (chunked) together to be executed sequentially on the batch system as a single batch job.
This is especially useful to avoid overburding the scheduler by submitting thousands of jobs simultaneously.
To chunk jobs together, job ids must be provided as <code>data.frame</code> with columns &#8220;job.id&#8221; and &#8220;chunk&#8221; (integer).
All jobs with the same chunk number will be executed sequentially inside the same batch job.
The utility functions <code><a href='chunk.html'>chunk</a></code>, <code><a href='chunk.html'>binpack</a></code> and <code><a href='chunk.html'>lpt</a></code>
can assist in grouping jobs.</p>
    <h2 class="hasAnchor" id="array-jobs"><a class="anchor" href="#array-jobs"></a>Array Jobs</h2>

    

<p>If your cluster supports array jobs, you can set the resource <code>chunks.as.arrayjobs</code> to <code>TRUE</code> in order
to execute chunks as job arrays on the cluster.
For each chunk of size <code>n</code>, <span class="pkg">batchtools</span> creates a <code><a href='makeJobCollection.html'>JobCollection</a></code> of (possibly heterogeneous) jobs which is
submitted to the scheduler as a single array job with <code>n</code> repetitions.
For each repetition, the <code>JobCollection</code> is first read from the file system, then subsetted to the <code>i</code>-th job using
the environment variable <code>reg$cluster.functions$array.var</code> (depending on the cluster backend, defined automatically) and finally
executed.</p>
    <h2 class="hasAnchor" id="order-of-submission"><a class="anchor" href="#order-of-submission"></a>Order of Submission</h2>

    

<p>Jobs are submitted in the order of chunks, i.e. jobs which have chunk number
<code>sort(unique(ids$chunk))[1]</code> first, then jobs with chunk number <code>sort(unique(ids$chunk))[2]</code>
and so on. If no chunks are provided, jobs are submitted in the order of <code>ids$job.id</code>.</p>
    <h2 class="hasAnchor" id="limiting-the-number-of-jobs"><a class="anchor" href="#limiting-the-number-of-jobs"></a>Limiting the Number of Jobs</h2>

    

<p>If requested, <code>submitJobs</code> tries to limit the number of concurrent jobs of the user by waiting until jobs terminate
before submitting new ones.
This can be controlled by setting &#8220;max.concurrent.jobs&#8221; in the configuration file (see <code><a href='makeRegistry.html'>Registry</a></code>)
or by setting the resource &#8220;max.concurrent.jobs&#8221; to the maximum number of jobs to run simultaneously.
If both are set, the setting via the resource takes precedence over the setting in the configuration.</p>
    <h2 class="hasAnchor" id="measuring-memory"><a class="anchor" href="#measuring-memory"></a>Measuring Memory</h2>

    

<p>Setting the resource <code>measure.memory</code> to <code>TRUE</code> turns on memory measurement:
<code><a href='https://rdrr.io/r/base/gc.html'>gc</a></code> is called  directly before and after the job and the difference is
stored in the internal database. Note that this is just a rough estimate and does
neither work reliably for external code like C/C++ nor in combination with threading.</p>
    <h2 class="hasAnchor" id="inner-parallelization"><a class="anchor" href="#inner-parallelization"></a>Inner Parallelization</h2>

    

<p>Inner parallelization is typically done via threading, sockets or MPI.
Two backends are supported to assist in setting up inner parallelization.</p>
<p>The first package is <span class="pkg">parallelMap</span>.
If you set the resource &#8220;pm.backend&#8221; to &#8220;multicore&#8221;, &#8220;socket&#8221; or &#8220;mpi&#8221;,
<code><a href='https://parallelmap.mlr-org.com/reference/parallelStart.html'>parallelStart</a></code> is called on the slave before the first job in the chunk is started
and <code><a href='https://parallelmap.mlr-org.com/reference/parallelStop.html'>parallelStop</a></code> is called after the last job terminated.
This way, the resources for inner parallelization can be set and get automatically stored just like other computational resources.
The function provided by the user just has to call <code><a href='https://parallelmap.mlr-org.com/reference/parallelMap.html'>parallelMap</a></code> to start parallelization using the preconfigured backend.</p>
<p>To control the number of CPUs, you have to set the resource <code>ncpus</code>.
Otherwise <code>ncpus</code> defaults to the number of available CPUs (as reported by (see <code><a href='https://rdrr.io/r/parallel/detectCores.html'>detectCores</a></code>))
on the executing machine for multicore and socket mode and defaults to the return value of <code><a href='https://rdrr.io/pkg/Rmpi/man/mpi.universe.size.html'>mpi.universe.size</a>-1</code> for MPI.
Your template must be set up to handle the parallelization, e.g. request the right number of CPUs or start R with <code>mpirun</code>.
You may pass further options like <code>level</code> to <code><a href='https://parallelmap.mlr-org.com/reference/parallelStart.html'>parallelStart</a></code> via the named list &#8220;pm.opts&#8221;.</p>
<p>The second supported parallelization backend is <span class="pkg">foreach</span>.
If you set the resource &#8220;foreach.backend&#8221; to &#8220;seq&#8221; (sequential mode), &#8220;parallel&#8221; (<span class="pkg">doParallel</span>) or
&#8220;mpi&#8221; (<span class="pkg">doMPI</span>), the requested <span class="pkg">foreach</span> backend is automatically registered on the slave.
Again, the resource <code>ncpus</code> is used to determine the number of CPUs.</p>
<p>Neither the namespace of <span class="pkg">parallelMap</span> nor the namespace <span class="pkg">foreach</span> are attached.
You have to do this manually via <code><a href='https://rdrr.io/r/base/library.html'>library</a></code> or let the registry load the packages for you.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'> <span class='fu'>batchtools</span><span class='fu'>:::</span><span class='fu'>example_push_temp</span><span class='op'>(</span><span class='fl'>3</span><span class='op'>)</span> 
<span class='co'>### Example 1: Submit subsets of jobs</span>
<span class='va'>tmp</span> <span class='op'>=</span> <span class='fu'><a href='makeRegistry.html'>makeRegistry</a></span><span class='op'>(</span>file.dir <span class='op'>=</span> <span class='cn'>NA</span>, make.default <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>No readable configuration file found</span></div><div class='output co'>#&gt; <span class='message'>Created registry in '/tmp/batchtools-example/reg1' using cluster functions 'Interactive'</span></div><div class='input'>
<span class='co'># toy function which fails if x is even and an input file does not exists</span>
<span class='va'>fun</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>fn</span><span class='op'>)</span> <span class='kw'>if</span> <span class='op'>(</span><span class='va'>x</span> <span class='op'>%%</span> <span class='fl'>2</span> <span class='op'>==</span> <span class='fl'>0</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/files.html'>file.exists</a></span><span class='op'>(</span><span class='va'>fn</span><span class='op'>)</span><span class='op'>)</span> <span class='kw'><a href='https://rdrr.io/r/base/stop.html'>stop</a></span><span class='op'>(</span><span class='st'>"file not found"</span><span class='op'>)</span> <span class='kw'>else</span> <span class='va'>x</span>

<span class='co'># define jobs via batchMap</span>
<span class='va'>fn</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempfile</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>ids</span> <span class='op'>=</span> <span class='fu'><a href='batchMap.html'>batchMap</a></span><span class='op'>(</span><span class='va'>fun</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>20</span>, reg <span class='op'>=</span> <span class='va'>tmp</span>, fn <span class='op'>=</span> <span class='va'>fn</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Adding 20 jobs ...</span></div><div class='input'>
<span class='co'># submit some jobs</span>
<span class='va'>ids</span> <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>
<span class='fu'>submitJobs</span><span class='op'>(</span><span class='va'>ids</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Submitting 10 jobs in 10 chunks using cluster functions 'Interactive' ...</span></div><div class='output co'>#&gt; Error in (function (x, fn)  : file not found
#&gt; Error in (function (x, fn)  : file not found
#&gt; Error in (function (x, fn)  : file not found
#&gt; Error in (function (x, fn)  : file not found
#&gt; Error in (function (x, fn)  : file not found</div><div class='input'><span class='fu'><a href='waitForJobs.html'>waitForJobs</a></span><span class='op'>(</span><span class='va'>ids</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] FALSE</div><div class='input'><span class='fu'><a href='getStatus.html'>getStatus</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Status for 20 jobs at 2020-10-21 09:39:31:
#&gt;   Submitted    : 10 ( 50.0%)
#&gt;   -- Queued    :  0 (  0.0%)
#&gt;   -- Started   : 10 ( 50.0%)
#&gt;   ---- Running :  0 (  0.0%)
#&gt;   ---- Done    :  5 ( 25.0%)
#&gt;   ---- Error   :  5 ( 25.0%)
#&gt;   ---- Expired :  0 (  0.0%)</div><div class='input'>
<span class='co'># create the required file and re-submit failed jobs</span>
<span class='fu'><a href='https://rdrr.io/r/base/files.html'>file.create</a></span><span class='op'>(</span><span class='va'>fn</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'><span class='fu'>submitJobs</span><span class='op'>(</span><span class='fu'><a href='findJobs.html'>findErrors</a></span><span class='op'>(</span><span class='va'>ids</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Submitting 5 jobs in 5 chunks using cluster functions 'Interactive' ...</span></div><div class='input'><span class='fu'><a href='getStatus.html'>getStatus</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Status for 20 jobs at 2020-10-21 09:39:31:
#&gt;   Submitted    : 10 ( 50.0%)
#&gt;   -- Queued    :  0 (  0.0%)
#&gt;   -- Started   : 10 ( 50.0%)
#&gt;   ---- Running :  0 (  0.0%)
#&gt;   ---- Done    : 10 ( 50.0%)
#&gt;   ---- Error   :  0 (  0.0%)
#&gt;   ---- Expired :  0 (  0.0%)</div><div class='input'>
<span class='co'># submit remaining jobs which have not yet been submitted</span>
<span class='va'>ids</span> <span class='op'>=</span> <span class='fu'><a href='findJobs.html'>findNotSubmitted</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
<span class='fu'>submitJobs</span><span class='op'>(</span><span class='va'>ids</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Submitting 10 jobs in 10 chunks using cluster functions 'Interactive' ...</span></div><div class='input'><span class='fu'><a href='getStatus.html'>getStatus</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Status for 20 jobs at 2020-10-21 09:39:31:
#&gt;   Submitted    : 20 (100.0%)
#&gt;   -- Queued    :  0 (  0.0%)
#&gt;   -- Started   : 20 (100.0%)
#&gt;   ---- Running :  0 (  0.0%)
#&gt;   ---- Done    : 20 (100.0%)
#&gt;   ---- Error   :  0 (  0.0%)
#&gt;   ---- Expired :  0 (  0.0%)</div><div class='input'>
<span class='co'># collect results</span>
<span class='fu'><a href='reduceResultsList.html'>reduceResultsList</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [[1]]
#&gt; [1] 1
#&gt; 
#&gt; [[2]]
#&gt; [1] 2
#&gt; 
#&gt; [[3]]
#&gt; [1] 3
#&gt; 
#&gt; [[4]]
#&gt; [1] 4
#&gt; 
#&gt; [[5]]
#&gt; [1] 5
#&gt; 
#&gt; [[6]]
#&gt; [1] 6
#&gt; 
#&gt; [[7]]
#&gt; [1] 7
#&gt; 
#&gt; [[8]]
#&gt; [1] 8
#&gt; 
#&gt; [[9]]
#&gt; [1] 9
#&gt; 
#&gt; [[10]]
#&gt; [1] 10
#&gt; 
#&gt; [[11]]
#&gt; [1] 11
#&gt; 
#&gt; [[12]]
#&gt; [1] 12
#&gt; 
#&gt; [[13]]
#&gt; [1] 13
#&gt; 
#&gt; [[14]]
#&gt; [1] 14
#&gt; 
#&gt; [[15]]
#&gt; [1] 15
#&gt; 
#&gt; [[16]]
#&gt; [1] 16
#&gt; 
#&gt; [[17]]
#&gt; [1] 17
#&gt; 
#&gt; [[18]]
#&gt; [1] 18
#&gt; 
#&gt; [[19]]
#&gt; [1] 19
#&gt; 
#&gt; [[20]]
#&gt; [1] 20
#&gt; </div><div class='input'>
<span class='co'>### Example 2: Using memory measurement</span>
<span class='va'>tmp</span> <span class='op'>=</span> <span class='fu'><a href='makeRegistry.html'>makeRegistry</a></span><span class='op'>(</span>file.dir <span class='op'>=</span> <span class='cn'>NA</span>, make.default <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>No readable configuration file found</span></div><div class='output co'>#&gt; <span class='message'>Created registry in '/tmp/batchtools-example/reg2' using cluster functions 'Interactive'</span></div><div class='input'>
<span class='co'># Toy function which creates a large matrix and returns the column sums</span>
<span class='va'>fun</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>n</span>, <span class='va'>p</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>colMeans</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='va'>n</span><span class='op'>*</span><span class='va'>p</span><span class='op'>)</span>, <span class='va'>n</span>, <span class='va'>p</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># Arguments to fun:</span>
<span class='va'>args</span> <span class='op'>=</span> <span class='fu'>data.table</span><span class='fu'>::</span><span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/J.html'>CJ</a></span><span class='op'>(</span>n <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1e4</span>, <span class='fl'>1e5</span><span class='op'>)</span>, p <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='fl'>50</span><span class='op'>)</span><span class='op'>)</span> <span class='co'># like expand.grid()</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>args</span><span class='op'>)</span>
</div><div class='output co'>#&gt;        n  p
#&gt; 1: 1e+04 10
#&gt; 2: 1e+04 50
#&gt; 3: 1e+05 10
#&gt; 4: 1e+05 50</div><div class='input'>
<span class='co'># Map function to create jobs</span>
<span class='va'>ids</span> <span class='op'>=</span> <span class='fu'><a href='batchMap.html'>batchMap</a></span><span class='op'>(</span><span class='va'>fun</span>, args <span class='op'>=</span> <span class='va'>args</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Adding 4 jobs ...</span></div><div class='input'>
<span class='co'># Set resources: enable memory measurement</span>
<span class='va'>res</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>measure.memory <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='co'># Submit jobs using the currently configured cluster functions</span>
<span class='fu'>submitJobs</span><span class='op'>(</span><span class='va'>ids</span>, resources <span class='op'>=</span> <span class='va'>res</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Submitting 4 jobs in 4 chunks using cluster functions 'Interactive' ...</span></div><div class='input'>
<span class='co'># Retrive information about memory, combine with parameters</span>
<span class='va'>info</span> <span class='op'>=</span> <span class='fu'><a href='JoinTables.html'>ijoin</a></span><span class='op'>(</span><span class='fu'><a href='getJobTable.html'>getJobStatus</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'>.</span><span class='op'>(</span><span class='va'>job.id</span>, <span class='va'>mem.used</span><span class='op'>)</span><span class='op'>]</span>, <span class='fu'><a href='getJobTable.html'>getJobPars</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'><a href='unwrap.html'>unwrap</a></span><span class='op'>(</span><span class='va'>info</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt;    job.id mem.used     n  p
#&gt; 1:      1 145.3133 1e+04 10
#&gt; 2:      2 145.3144 1e+04 50
#&gt; 3:      3 145.3146 1e+05 10
#&gt; 4:      4 145.3153 1e+05 50</div><div class='input'>
<span class='co'># Combine job info with results -&gt; each job is aggregated using mean()</span>
<span class='fu'><a href='unwrap.html'>unwrap</a></span><span class='op'>(</span><span class='fu'><a href='JoinTables.html'>ijoin</a></span><span class='op'>(</span><span class='va'>info</span>, <span class='fu'><a href='reduceResultsList.html'>reduceResultsDataTable</a></span><span class='op'>(</span>fun <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>res <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>res</span><span class='op'>)</span><span class='op'>)</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt;    job.id mem.used     n  p       res
#&gt; 1:      1 145.3133 1e+04 10 0.5005778
#&gt; 2:      2 145.3144 1e+04 50 0.4992527
#&gt; 3:      3 145.3146 1e+05 10 0.5000026
#&gt; 4:      4 145.3153 1e+05 50 0.4999301</div><div class='input'>
<span class='co'>### Example 3: Multicore execution on the slave</span>
<span class='va'>tmp</span> <span class='op'>=</span> <span class='fu'><a href='makeRegistry.html'>makeRegistry</a></span><span class='op'>(</span>file.dir <span class='op'>=</span> <span class='cn'>NA</span>, make.default <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>No readable configuration file found</span></div><div class='output co'>#&gt; <span class='message'>Created registry in '/tmp/batchtools-example/reg3' using cluster functions 'Interactive'</span></div><div class='input'>
<span class='co'># Function which sleeps 10 seconds, i-times</span>
<span class='va'>f</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>i</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'>parallelMap</span><span class='fu'>::</span><span class='fu'><a href='https://parallelmap.mlr-org.com/reference/parallelMap.html'>parallelMap</a></span><span class='op'>(</span><span class='va'>Sys.sleep</span>, <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='va'>i</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># Create one job with parameter i=4</span>
<span class='va'>ids</span> <span class='op'>=</span> <span class='fu'><a href='batchMap.html'>batchMap</a></span><span class='op'>(</span><span class='va'>f</span>, i <span class='op'>=</span> <span class='fl'>4</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'>Adding 1 jobs ...</span></div><div class='input'>
<span class='co'># Set resources: Use parallelMap in multicore mode with 4 CPUs</span>
<span class='co'># batchtools internally loads the namespace of parallelMap and then</span>
<span class='co'># calls parallelStart() before the job and parallelStop() right</span>
<span class='co'># after the job last job in the chunk terminated.</span>
<span class='va'>res</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>pm.backend <span class='op'>=</span> <span class='st'>"multicore"</span>, ncpus <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>{</span>
<span class='co'># Submit both jobs and wait for them</span>
<span class='fu'>submitJobs</span><span class='op'>(</span>resources <span class='op'>=</span> <span class='va'>res</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
<span class='fu'><a href='waitForJobs.html'>waitForJobs</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>

<span class='co'># If successfull, the running time should be ~10s</span>
<span class='fu'><a href='getJobTable.html'>getJobTable</a></span><span class='op'>(</span>reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span><span class='op'>[</span>, <span class='fu'>.</span><span class='op'>(</span><span class='va'>job.id</span>, <span class='va'>time.running</span><span class='op'>)</span><span class='op'>]</span>

<span class='co'># There should also be a note in the log:</span>
<span class='fu'><a href='grepLogs.html'>grepLogs</a></span><span class='op'>(</span>pattern <span class='op'>=</span> <span class='st'>"parallelMap"</span>, reg <span class='op'>=</span> <span class='va'>tmp</span><span class='op'>)</span>
<span class='op'>}</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Michel Lang, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


